# Hybrid Market Ensemble with Rolling LLM Expert

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªå…ˆè¿›çš„å¤šæ¨¡å‹é‡åŒ–é¢„æµ‹æ¡†æ¶ï¼Œç»“åˆä¼ ç»Ÿæœºå™¨å­¦ä¹ æ¨¡å‹ä¸LLMä¸“å®¶ç³»ç»Ÿï¼Œä¸¥æ ¼éµå¾ªæ—¶é—´åºåˆ—éªŒè¯åŸåˆ™ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

1. **å¤šæ¨¡å‹é›†æˆç­–ç•¥**ï¼šLSTMã€LightGBMã€LLMä¸“å®¶ååŒé¢„æµ‹
2. **ä¸¥æ ¼æ»šåŠ¨çª—éªŒè¯**ï¼šæ‰€æœ‰æ¨¡å‹åœ¨è®­ç»ƒé›†è®­ç»ƒï¼Œåœ¨ç‹¬ç«‹éªŒè¯é›†è¯„ä¼°
3. **LLMä¸“å®¶å®‰å…¨é›†æˆ**ï¼šLLMæ¦‚ç‡ä»…ä½œä¸ºä¸“å®¶å‚ä¸ï¼Œé¿å…ä¿¡æ¯æ³„æ¼
4. **è·¨å¸‚åœºç‰¹å¾èåˆ**ï¼šæ”¯æŒå¤šå¸‚åœºæ•°æ®è¿ç§»å­¦ä¹ 
5. **æ™ºèƒ½Meta-Learner**ï¼šåŠ¨æ€è°ƒæ•´æ¨¡å‹æƒé‡ï¼Œæ”¯æŒç¼ºå¤±æ ·æœ¬å¤„ç†

## ğŸ“Š æ¨¡å‹æ¶æ„

### åŸºç¡€é¢„æµ‹å™¨ (BasePredictor)
- ç»Ÿä¸€çš„æ¨¡å‹æ¥å£æŠ½è±¡
- æ”¯æŒè®­ç»ƒã€é¢„æµ‹ã€ä¿å­˜ã€åŠ è½½
- ç¡®ä¿æ‰€æœ‰æ¨¡å‹éµå¾ªç›¸åŒåè®®

### LSTMæ·±åº¦æ¨¡å‹
- å¤„ç†æ—¶åºåºåˆ—æ•°æ®
- åŒå‘LSTMæ¶æ„
- Dropoutæ­£åˆ™åŒ–é˜²æ­¢è¿‡æ‹Ÿåˆ
- æ—©åœæœºåˆ¶åŸºäºéªŒè¯é›†æŸå¤±

### LightGBMæ ‘æ¨¡å‹  
- æ¢¯åº¦æå‡å†³ç­–æ ‘
- å†…ç½®ç‰¹å¾é‡è¦æ€§åˆ†æ
- æ”¯æŒearly stoppingéªŒè¯

### LLMä¸“å®¶ç³»ç»Ÿ
- ä¸¥æ ¼æ»šåŠ¨çª—ç”Ÿæˆé¢„æµ‹
- OpenAI APIé›†æˆ + æœ¬åœ°å›é€€æœºåˆ¶
- æç¤ºå·¥ç¨‹ä¼˜åŒ–é‡åŒ–é¢„æµ‹

### Meta-Learneré›†æˆå™¨
- åŠ¨æ€æ¨¡å‹æƒé‡åˆ†é…
- åŸºäºè¿‘æœŸè¡¨ç°è°ƒæ•´
- é²æ£’æ€§ç¼ºå¤±å€¼å¤„ç†

---

## ç›®å½•ç»“æ„

| è·¯å¾„ | ä½œç”¨ |
|------|------|
| `requirements.txt` | Python ä¾èµ–æ¸…å• |
| `src/main.py` | ç¨‹åºå…¥å£ï¼ŒåŠ è½½é…ç½®å¹¶è§¦å‘å…¨æµç¨‹ |
| `src/config.py` | é»˜è®¤é…ç½®ï¼ˆç‰¹å¾åˆ—ã€çª—å£é•¿åº¦ã€LLM å‚æ•°ã€æ•°æ®æºç­‰ï¼‰ |
| `src/data_manager.py` | DataManagerï¼šè¯»å–åŸå§‹æ•°æ®ã€ç”ŸæˆæŠ€æœ¯æŒ‡æ ‡ã€æ„é€  LSTM åºåˆ— |
| `src/cross_asset.py` | è®­ç»ƒè·¨å¸‚åœºæ¨¡å‹å¹¶è¾“å‡ºæ»šåŠ¨æ¦‚ç‡ç‰¹å¾ï¼ˆç¤ºä¾‹ï¼šUS_NDX_predï¼‰ |
| `src/models.py` | æ¨¡å‹å®šä¹‰ï¼šBasePredictorã€LSTMã€LightGBMã€LLM ä¸“å®¶ |
| `src/services.py` | RollingLLMServiceï¼šä¸¥æ ¼æ»šåŠ¨çª—ã€æ”¯æŒ OpenAI / fallback |
| `src/meta.py` | MetaLearnerï¼šæŒ‰æ¨¡å‹æœ‰æ•ˆæ ·æœ¬è®¡ç®— BCEã€è¾“å‡ºæƒé‡ |
| `src/experiments.py` | å®éªŒç®¡çº¿ï¼š`run_experiment`ã€`evaluate_and_compare`ã€`main_pipeline_with_comparison` |

---

## ğŸš€ ä¸¥æ ¼è®­ç»ƒéªŒè¯æµç¨‹

### æ•°æ®æ‹†åˆ†ç­–ç•¥
```python
# æ—¶é—´åºåˆ—ä¸¥æ ¼æ‹†åˆ†
train_end = i - valid_len - 1      # è®­ç»ƒé›†ç»“æŸ
valid_start = i - valid_len        # éªŒè¯é›†å¼€å§‹  
valid_end = i - 1                  # éªŒè¯é›†ç»“æŸ
test_index = i                     # æµ‹è¯•ç´¢å¼•ï¼ˆå½“å‰äº¤æ˜“æ—¥ï¼‰
```

### ğŸ¯ æ¨¡å‹è®­ç»ƒéªŒè¯æµç¨‹

#### LSTMæ·±åº¦æ¨¡å‹
- **è®­ç»ƒ**: åœ¨å†å²è®­ç»ƒé›†ä¸Šè®­ç»ƒå¤šä¸ªepoch
- **éªŒè¯**: æ¯ä¸ªepochååœ¨ç‹¬ç«‹éªŒè¯é›†è®¡ç®—æŸå¤±
- **æ—©åœ**: åŸºäºéªŒè¯é›†æŸå¤±é€‰æ‹©æœ€ä¼˜æ¨¡å‹çŠ¶æ€
- **ç‰¹å¾**: æ—¶åºåºåˆ—ç‰¹å¾ (log_ret, ma5, ma10, ma20ç­‰)

#### LightGBMæ ‘æ¨¡å‹
- **è®­ç»ƒ**: æ¢¯åº¦æå‡å†³ç­–æ ‘åœ¨è®­ç»ƒé›†æ‹Ÿåˆ
- **éªŒè¯**: æ”¯æŒéªŒè¯é›†early stoppingé˜²æ­¢è¿‡æ‹Ÿåˆ
- **ç›‘æ§**: éªŒè¯é›†binary_loglossä½œä¸ºåœæ­¢æ ‡å‡†
- **ç‰¹å¾**: æŠ€æœ¯æŒ‡æ ‡ç‰¹å¾ + å¯é€‰è·¨å¸‚åœºç‰¹å¾

#### LLMä¸“å®¶ç³»ç»Ÿ
- **è®­ç»ƒ**: æ— ä¼ ç»Ÿè®­ç»ƒï¼ŒåŸºäºæç¤ºå·¥ç¨‹
- **éªŒè¯**: ä¸¥æ ¼æ»šåŠ¨çª—è®¾è®¡ï¼Œé¿å…æœªæ¥ä¿¡æ¯
- **å›é€€**: OpenAI APIä¸å¯ç”¨æ—¶ä½¿ç”¨æœ¬åœ°åŠ¨é‡ç­–ç•¥
- **å®‰å…¨**: LLMè¾“å‡ºä»…ä½œä¸ºä¸“å®¶æ¦‚ç‡ï¼Œä¸æ³„éœ²åˆ°ç‰¹å¾

#### Meta-Learneré›†æˆ
- **è¾“å…¥**: å„æ¨¡å‹åœ¨éªŒè¯é›†çš„è¿‘æœŸé¢„æµ‹è¡¨ç°
- **ä¼˜åŒ–**: åŸºäºéªŒè¯é›†è¡¨ç°åŠ¨æ€è°ƒæ•´æ¨¡å‹æƒé‡
- **é²æ£’**: æ”¯æŒæ¨¡å‹ç¼ºå¤±æ ·æœ¬ï¼Œæœ€å°æ ·æœ¬æ•°æ§åˆ¶

### ğŸ“ˆ è¯„ä¼°æŒ‡æ ‡ä½“ç³»
| æŒ‡æ ‡ | è¯´æ˜ | è®¡ç®—æ–¹å¼ |
|------|------|----------|
| **å‡†ç¡®ç‡** | é¢„æµ‹æ–¹å‘æ­£ç¡®ç‡ | (æ­£ç¡®é¢„æµ‹æ•°) / æ€»é¢„æµ‹æ•° |
| **ç´¯è®¡æ”¶ç›Š** | ç­–ç•¥æ€»æ”¶ç›Š | âˆ‘(ä»“ä½ Ã— æ¬¡æ—¥æ”¶ç›Š) |
| **åšå¤šå‘½ä¸­ç‡** | åšå¤šæ—¶çš„ä¸Šæ¶¨æ¦‚ç‡ | (åšå¤šä¸”ä¸Šæ¶¨å¤©æ•°) / æ€»åšå¤šå¤©æ•° |
| **å¹³å‡æ¦‚ç‡** | å¹³å‡é¢„æµ‹ç½®ä¿¡åº¦ | æ‰€æœ‰é¢„æµ‹æ¦‚ç‡çš„å‡å€¼ |

### âš¡ æ€§èƒ½ä¼˜åŒ–
- **é‡è®­ç»ƒé—´éš”**: é…ç½®`retrain_interval`æ§åˆ¶è®­ç»ƒé¢‘ç‡
- **éªŒè¯çª—å£**: `valid_len`æ§åˆ¶éªŒè¯é›†å¤§å°
- **å…ƒå­¦ä¹ çª—å£**: `meta_window`æ§åˆ¶æƒé‡æ›´æ–°çµæ•åº¦

---

## æ•°æ®çº¦å®š

- CSV/Parquet ä¸­è‡³å°‘åŒ…å« `date, open, high, low, close, volume` åˆ—ã€‚
- `config["data_sources"]` å¯è‡ªå®šä¹‰è·¯å¾„ã€æ—¥æœŸåˆ—åã€åˆ—æ˜ å°„ã€‚
- `DataManager.generate_target_features_base` ä¼šç”Ÿæˆï¼š
  - `log_ret`ï¼šå¯¹æ•°æ”¶ç›Š
  - `ma5/ma10/ma20`
  - `ret_1d_ahead`ï¼šä¸‹ä¸€äº¤æ˜“æ—¥æ”¶ç›Š
  - `label`ï¼šä¸‹ä¸€äº¤æ˜“æ—¥æ–¹å‘ï¼ˆ>0 ä¸º 1ï¼‰

---

## è¿è¡Œ & æ‰©å±•

1. `python -m src.main`
2. æ ¹æ®éœ€è¦å¯ç”¨/ç¦ç”¨ `use_cross_ndx`, `use_llm_as_expert`, `use_peer_transfer` ç­‰é…ç½®ã€‚
3. è‹¥è¦æ¥å…¥çœŸå® LLM APIï¼Œè®¾ç½® `LLM_API_KEY` ç¯å¢ƒå˜é‡æˆ– `config["llm_api_key"]`ï¼Œå¹¶åœ¨ `RollingLLMService._call_llm_and_parse_prob` ä¸­ä½¿ç”¨çœŸå®æ¨¡å‹ã€‚

---

## å…³é”®è®¾è®¡è¯´æ˜

- **æ»šåŠ¨ LLM**ï¼šåœ¨ `RollingLLMService.get_prob_for_date` ä¸­ï¼Œä»…ä½¿ç”¨ <= å½“å‰æ—¥æœŸçš„æ•°æ®æ„é€  promptï¼Œå¹¶å¯¹ä¸‹ä¸€äº¤æ˜“æ—¥ç»™å‡ºæ¦‚ç‡ã€‚é¢„æµ‹ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è°ƒç”¨ã€‚
- **LLM ä»…ä½œä¸“å®¶**ï¼š`LLMPredictor` åªæš´éœ² `predict_proba`ï¼Œä¸ä¼šæŠŠ LLM è¾“å‡ºæ³¨å…¥ `feature_cols_*`ã€‚
- **Meta-Learner ç¼ºå¤±æ”¯æŒ**ï¼š`MetaLearner.update_weights` å¯¹æ¯ä¸ªæ¨¡å‹ç‹¬ç«‹ç­›é€‰æœ‰æ•ˆæ ·æœ¬ï¼Œå°‘äº `min_samples` æ—¶è·³è¿‡æˆ–ä½¿ç”¨é»˜è®¤ç­–ç•¥ã€‚
- **è·¨å¸‚åœºç‰¹å¾**ï¼š`generate_cross_asset_predictions` ç”¨æ»šåŠ¨ Logistic Regressionï¼Œåœ¨æ—¥æœŸ `t` åªç”¨ `<= t-1` çš„æ ·æœ¬è®­ç»ƒï¼Œå†é¢„æµ‹ `t`ï¼ˆå¯¹åº” `t+1` æ–¹å‘ï¼‰ï¼Œæœ€åä¸ A è‚¡äº¤æ˜“æ—¥å¯¹é½ã€‚

---

## å¸¸è§ä¿®æ”¹ç‚¹

- æ›´æ¢ç‰¹å¾ï¼šè°ƒæ•´ `config["feature_cols_*"]`ã€‚
- æ–°å¢è·¨å¸‚åœºï¼šåœ¨ `config["cross_asset_sources"]` å¢åŠ æ¡ç›®ï¼Œå¹¶è°ƒç”¨ `generate_cross_asset_predictions`ã€‚
- æ›´æ¢ LLMï¼šä¿®æ”¹ `config["llm_model_name"]`ã€`llm_temperature`ï¼Œæˆ–åœ¨ `RollingLLMService` ä¸­æ›¿æ¢ API è°ƒç”¨ã€‚
- è°ƒæ•´ Meta-Learnerï¼šè®¾ç½® `meta_window`, `meta_eta`, `min_samples` æ§åˆ¶æƒé‡æ›´æ–°çµæ•åº¦ã€‚

---

## License

è‡ªå®šä¹‰æˆ–å¡«å†™ä¼ä¸šå†…éƒ¨è®¸å¯å³å¯ã€‚